### 架构师的视角 

- [[远程服务调用]]
- [[事务处理]]
- [[透明多级分流系统]]
- [[架构安全性]] 


#### 远程访问服务  
  ##### 进程间通信  
 - 考虑事项  
  - 传递方法参数  
  - 确定方法版本  
  - 执行被调用方法  
  - 返回执行结果  
 - 考虑的方法  
  - 管道  
  - 信号  
  - 信号量  
  - 共享内存  
  - 套接字接口     
  ##### 通信成本  
  ##### 疑问  
     - 两个进程通信 谁作为服务端 谁作为客户端  
     - 怎样进行异常处理, 异常如何让调用者获知  
     - 服务端出现多线程竞争之后怎么办  
     - 如何提高网络的利用效率，连接是否可以多路复用减少开销，知否支持多播  
     - 参数 返回值如何表示，应该有怎样的字节序列  
     - 如何保证网络的可靠性  
     - 发送情况，收不到服务端返回怎么办  
  ##### 分布式网络假设前提  
  - 网路是可靠的， the network is reliable  
  - 延迟是不存在的 latency is zero  
  - 带宽是无限的  bandwith is infinite  
  - 网络是安全的 the network is  secure  
  - 拓部结构是一成不变的 topology doesn't change  
  - 总会有一个管理员 there is one administrator  
  - 不考虑传输成本 transport is zero   
  - 网络是同质化的 the network is homogeneous  
  - 分布式三个定义  
  - 如何表示是数据  
  - 如何传递数据  
  - 如何确定方法        
  - 统一的RPC VS 分裂的RPC  
- Rest设计风格  
  - REST的理解  
  
#### 事务处理  
  ##### 本地事务
  - 原子性 隔离性 持久性 都是手段， 目的是一致性
  - Atomic 原子性 isolation 隔离性 durability 持久性  consistency 一致性 
  - 未提交事务 写入后崩溃  // 已提交事务 写入前崩溃 
  - 提交日志（比较通用),所有对数据的真实修改都必须发生在事务提交以后 
  - 影子分页（效率更高，单涉及隔离性和并发锁时候，事务并发能力相对有限）  
  - commit logging /write-ahead logging 
  - force steal （再次理解）
  -  分析阶段 重做阶段 回滚阶段 
  -  实现隔离性
  - 写锁 读锁 范围锁
  - 串行化读 可重复读  读已提交 对未提交  
  -  幻读  不可重复读 脏读 
  - 读写事务 使用多版本并发控制 mvcc   CREATE_VERSION 和 DELETE_VERSION，这两个字段
  - 记录的值都是事务 ID 
	  - 读读场景  读写场景  写写场景 多版本控制针对读写场景
	  - 写写场景加锁 悲观锁  乐观锁
   ##### 全局事务
   - 本书限制定义范围是，一个服务多个数据源  
   -  XA 全局资源管理器TM(transaction manager) 局部资源管理器 RM(resource manager)  
   - 两阶段提交 2pc  
      - 准备阶段 投票阶段 与本地事务区别只是没有提交 commit record  
      - 提交阶段 执行阶段 各个事务 执行commit record  
      - 保证一致性的前提条件  
        - 假设网络短时间内是可靠的,投票阶段失败可以补救回滚，提交阶段无法弥补，因此要尽可能的短，为了尽量控制网络风险  
        - 必须假设因为网络分区、机器崩溃或者其他原因而导致失联的节点最终能够恢复，不会永久性地处于失联状态 
      - 缺点  
        - 单点问题 协调者  
        - 性能问题 两阶段提交，所有参与者相当于被绑定成为一个统一调度的整体，两次远程服务调用，三次数据持久化  
        - 一致性风险  前提条件 
   - 三阶段提交 3PC  
      - CanCommit 询问阶段  
      - PreCommit   
      - DoCommit      
  ##### 共享事务
  -  多个服务共用一个数据源  
  ##### 分布式事务
 - 多个服务同时访问多个数据源的事务处理机制  
 - CAP   
 -  一致性 consistency  任何时刻，任意分布式节点所看到的节点都符合预期，与面向副本的一致性概念不同        
    - 可用性 Availiability 代表系统不间断提供服务的能力 
    - 可靠性（reliability）
    - 可维护性（serviceability）  
 >可靠性使用平均无故障时间（Mean Time Between Failure，MTBF）来度量； 可维护性使用平均可修复时间（Mean Time To Repair，MTTR）来度量。 可用性衡量系统可以正常使用的时间与总时间之比，其表征为：A=MTBF/（MTBF+MTTR）， 即可用性是由可靠性和可维护性计算得出的比例值 ``` - 分区容错 partition Tolerance 分布式节点因网络原因彼此失去联系，系统仍然能够正确提供服务能力
 - CP 放弃可用性 Hbase  
 - AP 放弃一致性 Redis 大多数NoSql  
 - CAP ACID  
 - 强一致性 最终一致性  
 - ACID 刚性事务  
 - 分布式事务几种处理方式  
	 - BASE 分别是基本可用性（Basically Available）、
	 - 柔性事务（Soft State）
	 - 和最终一致性（Eventually Consistent）  
     - 可靠消息队列 最大努力交付（Best-Effort Delivery），缺乏隔离性 会带来的一个显而易见的问题便是"超售"  
     - TCC 代码层面类似2pc,2pc是基础设施层面，有较高的灵活性，性能高，业务侵入高，替换成本高，有些场景不适用，比如用户银行卡支付，无法冻结余额  
     - try 尝试执行阶段，完成所有业务可执行性的检查（保障一致性），并且预留好全部需用到的业务资源（保障隔离性）
     -  confirm 确认执行阶段 不做任何检查，会重复执行，需要具备幂等性 
     - cancel 取消执行阶段，释放 Try 阶段预留的业务资源。Cancel 阶段可能会重复执行，也需要满足幂等性
    - SAGA 事务 长时间事务  
        - 大事务拆分若干小事务  
        - 为每个事务设计对应的补偿动作  
        - 恢复策略  
            - 正向恢复  
            - 反向恢复  
  
- 透明多级分流系统  经过网关、负载均衡器、缓存、服务集群等一系列设施  
>  客户端或网络边缘 迅速响应用户请求，避免给后端 i/o和cpu压力 如 本地缓存、cdn、反向代理 - 处理能力能线性扩展 易于伸缩 如集群 - 组件最全局稳定性有影响，要时刻保持容错备份 如 注册中心 配置中心 - 单点部件，只能靠提高带宽 网络 存储能力提升性能 如路由 网关 负载均衡，关系数据库 ``` - 设计系统进行流量规划的时候，分理解这些部件的价值差异，有两条简单、普适的原则能指导我们进行设计  
    - 尽可能减少单点部件  
    - 奥卡姆剃刀原则，如非必要，勿增实体，满足足球队前提下，最简单的系统就是最好的系统  

#### 缓存
  - 客户端缓存  
  - 域名解析  
  - 传输链路  
  - 内容分发网络CDN  
  - 负载均衡  
  - 服务端缓存  
    - 非必要不引入  
    
####  架构的安全性  
  - 认证  
  - 授权  
  - 凭证  
  - 保密  
  - 传输  
  - 验证  
    
-