### 复制

#### 为什么要复制
- 可扩展性：单机处理能力有限，不足以支撑业务需要
- 容错性： 每台机器都有可能出错
- 降低延迟：不同的用户访问，就近原则，访问最近的数据中心
- 高可用：一部分服务不能使用，可以路由到可用的服务上

#### 复制架构
- 共享架构
- 无共享架构

#### 复制与分区 
- 复制是 A = A”
- 分区是 A = A1+A2+A3
- 通常使用情况是 复制加分区一块使用

### 复制的方式
- 单主模式：一个领导者多个追随者，或者一个master 多个slave,主从架构
	- master负责写，slave负责读
	- 同步模式：数据一致性强，但是时效性差
	- 异步模式：时效性强，数据可能同步失败
	- 半同步模式：过半数的返回已经同步成功，表明成功，常用
	- 主节点宕机，如何节点切换?
		- 如何确认主库失效？超时配置
		- 副本投票，选主过程，投票机制
		- 如何统治副本
		- 分布式数据库不能使用自增id
		- 脑裂
	- 复制的具体实现
		- 基于语句的实现  可能出现的问题，自增的顺序性
		- 传输预习日志wal,write ahead log，与存储引擎有密切关系，升级数据库版本会出现问题
		- 基于逻辑日志，行的粒度，更容易解析 binlog
		- 基于触发器，自己实现，更灵活，但是需要技术债务
	- 复制延迟的问题
		- 最终一致性?多长时间达到一致
		- 写后读，也称读己之写，写主读从，由于复制需要时间，导致读写不一致，自己写的查不到，监控时间戳，时钟同步问题，同一用户尽量路由到同一数据中心
		- 只读，单调读，不同从库同步时间差异，前后两次读到数据不一致，尽量保证用户从指定数据库读
		- 一致性前缀，数据有关联性，数据顺序出现问题，尽量保证相关业务数据写到同一个分区或者从库
- 多主模式
	- 多数据中心
	- 数据中心停机，容忍网络问题，异步复制
	- 写冲突，避免冲突的方法，统一用户或者业务标识尽量路由到统一数据中心
	- 最后写入胜利
	- 读是执行，用户来选择，merge结果，CRDT数据库自行解决冲突
	- 多主的拓扑结构
- 无主模式
	- 所有节点平等，协调者
	- 变更：大多数返回，表明成功
	- 查询：数量多+版本号
	- 不一致处理办法
		- 读修复
		- 反熵过程（整理）
		- 读写的法定人数 quorum,过半数机制 w + r >n
	- Quorum 仲裁写入 法定读取
	- 版本号，向量时钟，因果上下文 
