### 微服务架构中进程间通信
- [[远程服务调用]]


- 通信模式的应用
	- 远程过程调用
	- 断路器
	- 客户端发现
	- 自注册
	- 服务器端发现
	- 第三方注册
	- 异步消息
	- 事务性发件箱
	- 事务日志拖尾
	- 轮循发布者

----

#### 进程间通信概述
##### 交互方式(客户端-服务端)
- 关注 一对一 一对多
	- 一对一：每个客户端请求由一个服务实例来处理
	- 一对多：每个客户端请求由多个服务实例来处理
- 关注同步和异步
		- 同步模式：客户端请求需要服务端实时响应，客户端等待响应时可能导致阻塞
		- 异步模式：客户端请求不会阻塞进程，服务端响应可以是非实时的
- ![[Pasted image 20220621152243.png]]


##### 微服务架构定义API
- api是软件开发的中心，应用是有模块构成的，每个模块都有接口，一个设计良好的接口会暴露有用的功能，并隐藏实现的细节
- API是服务与其客户端之间的契约，方法的名称，参数和返回类型
- API设计优先
- 如何定义api取决于进程间通信机制，使用消息机制，api有消息通道，消息类型，消息格式组成，使用http,则api有url http动词及请求和响应格式组成

##### API演进
- 语义化版本控制
	- major 不兼容更改
	- minor 向后兼容增强
	- patch 向后兼容错误修改

##### 消息的格式
- 基于文本的消息格式
	- json
	- xml
- 二进制消息格式
	- protocol buffers


#### 基于同步远程过程调用模式
- 使用Rest方式
	- rest成熟度模型 
	- 好处
		- 简单
		- 直接支持请求响应的通信方式
		- http对防火墙友好
		- 不需要中间代理
		- 可以使用浏览器扩展或curl之类命令执行
	- 弊端
		- 只支持请求响应
		- 可用性低，请求过多会阻塞，rest api必须保持在线
		- 客户端必须知道服务实例位置，服务发现问题
		- 单个请求获取多个资源有挑战性
		- 很难将多个更新操作映射到http动词
- 使用gRPC
	- 好处
		- 具有设计更复杂api
		- 高效，紧凑的进程间通信机制，尤其交换大量消息时候
		- 客户端和各种语言服务端之间调用
		- 远程调用和消息传递双向流式消息方式
	- 弊端
		- 客户端调用复杂相比于rest
		- 防火墙可能不支持http2
		- 存在局部故障的问题
	- 使用断路器处理局部[[熔断设计]]
		- 网络超时机制
		- 限制客户端向服务端发出请求的数量
		- 断路器模式 hystrix
		- 远程服务的恢复
			- 知道服务实例的网路位置，才能恢复
- 服务发现[[服务发现]]
	- 服务发现两种主要方式
		- 服务及其客户直接与服务注册表交互
		- 通过部署基础设施来处理服务发现
	- 应用层服务发现模式
		- 自注册
		- 客户端发现
		- 如eureka
		- 好处：可以处理多平台部署问题
		- 缺点：服务发现框架依赖语言，需要开发者维护，好的方式部署平台基础设施提供服务发现机制
	- 平台层服务发现模式
		- docker kubernets 内置服务注册表和服务发现机制
		- DNS 虚拟ip vip 及解析的服务
		- 服务端发现模式，客户端向DNS发出请求
		- 第三方注册模式，与服务本省解耦
		- 好处，完全有部署平台处理，客户端与服务端不需要任何服务发现代码
		- 坏处，限于支持该平台部署的服务

#### 基于异步消息模式的通信
- 消息
	- 消息组成：消息头+ 消息体
	- 消息类型：文档，命令，事件
- 消息通道
	- 消息通过消息通道进行交换
	- 发送端接口：发送端+消息发送适配器
	- 接收端接口：接收端+消息接收适配器
	- 消息通道类型
		- 点对点通道（通常命令消息）
		- 发布-订阅（通常事件消息）
- 消息机制
	- 价值在于灵活性
	- 实现单向通知
	- 实现发布/订阅
	- 实现发布/异步响应
- 消息代理[[中间件-消息队列]]
	- 无代理架构 zeroMQ
		- 好处：更地的网络流量和更地的延迟，消除消息代理成为瓶颈和单点故障的可能性，不需要维护消息代理
		- 坏处：必须使用[[服务发现]]机制，客户端和接收方必须同时在线，耦合性高
	- 基于代理的消息
		- [[rabbitmq]]  [[rocketmq]]  [[kafka]]
		- 需要考虑的因素
			- 支持的编程语言
			- 支持的消息标准 AMQP  STOMP
			- 消息排序
			- 投递保证
			- 持久性
			- 耐用性
			- 可扩展性
			- 延迟性
			- ![[Pasted image 20220621171631.png]]
	- 好处
		- 松耦合
		- 消息缓冲 削峰填谷
		- 灵活通信
		- 明确的进程间通信
	- 弊端
		- 潜在的性能瓶颈  高性能
		- 潜在的单点故障  高可用
		- 额外的操作复杂度
	- 挑战
		- 处理并发和消息顺序
			- 原因是多个实例或多线程处理
			- 处理方法
				- broker： 使用分片或分区通道
				- 发送端 ：消息发送发在消息头指定分片键字段，hash到指定通道
				- 接收端：消费组，消息代理将每个分片分配给单个接收器，接收方启动或关闭是重新分配分片
		- 处理重复消息
			- 处理程序幂等
			- 丢弃重复消息
- 事务性消息
	- 数据库表作为消息队列
		- 轮循模式发布事件
		- 使用事务日志拖尾模式发布事件

#### 使用异步消息提高可用性