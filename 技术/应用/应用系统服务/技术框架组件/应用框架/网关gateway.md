### 网关-gateway

#### 1.基本概念
- 网桥: ![[网络概念#^wq]]
- 网关: 宽泛的概念，连接不同网络的产品都可以称为网关
- 网桥一般只是转发消息，网关可能要进行包装
- 网关需要的基本功能
	- 统一入口    目的是与外界隔离保护里面的安全
	- 鉴权检验    相关认证是否通过  
	- 动态路由     匹配响应服务
	- 包装            加一层业务处理
- 为什么用网关
	- 单体架构是，客户端向后端请求发起REST调用获取数据，负载均衡器分发到N个相同应用实例的一个,然后应用程序，查询各种数据库，处理相应的业务逻辑，并将响应结果返回给客户端，微服务架构下，服务被拆分成过个微服务，如果所有微服务对外直接暴露，会出现各种问题，比如安全，前后端后严重；客户端可以请求每个微服务发送请求，会出现以下问题
		- 客户端需求和每个微服务暴露的细粒度API不匹配
		- 部分服务端协议不是http协议，可能是thrift、二进制RPC、AMQP 等
		- 微服务难以重构，如果合并两个服务，或拆分更多服务，重构会很麻烦
		- 微服务端各个服务可扩展性性和伸缩性也很差
-  网关是基础组件，位于接入层之下和服务层之上
- ![[gateway_location.png]]
##### 流量网关
- 图中显示多层网关，一个总的Gateway 接入所有流量称为 流量网关，控制流量进入集群的网关
- 定义是全局性的,根具体的后端业务和服务完全无关的策略网关
- 只关注全局的API管理策略
	- 全局流量监控
	- 日志记录
	- 全局限流  [[限流设计]]
	- 黑白名单控制
	- 接入业务系统的负载均衡
- 流量网关一般在业务网关之前，业务网关更靠近业务系统
-  开源产品 如Kong 典型的流量网关

##### 业务网关
- 二级网关处理各个子系统称为 业务网关
- 拆分微服务后，与业务系统非强相关的功能，通过功能，避免重复代码
	- 权限控制
	- 日志输出
	- 数据加密
	- 熔断限流   [[熔断设计]]
- 接口的集中管理
	- 接口有哪些
	- 接口的定义是什么
	- 接口的运行状态
- 业务网关体系结构
	- 校验拦截层
		- 反爬虫
		- 限流 [[限流设计]]
		- 黑白名单
		- XSS防御  
	- 服务调度层
		- 路由分发
		- 服务编排
	- 接口通讯层	 
		- 泛化调用(统一的入口)
		- 线程隔离
		- 熔断器
		- 协议适配
		- 服务降级
		- 接口上下线
		- 日志降级
		- 日志监控
		- 配置同步
		- mock测试
##### 网关是基础设施
- 应该具备的功能
	- 接口管理
	- 协议适配
	- 熔断限流[[熔断设计]] [[限流设计]]
	- 安全防护
- 开源网关产品 zuul 提供的功能
	- 鉴权管理
	- 日志监控
	- 熔断限流


#### 2.设计思路
>  一个网关需要那些功能 
##### 请求路由
- 
##### 服务注册
- 服务注册分类

##### 负载均衡
- 负载均衡的方式

##### 弹力设计
- [[弹力设计总结]]
- [[异步通讯设计|异步]]、[[重试设计|重试]]、[[幂等性设计|幂等]]、流控、[[熔断设计|熔断]]、监控 (service mesh  功能参照)

##### 安全方面
- SSL 加密及证书
- Session 验证、授权 
- 数据校验
- 恶意攻击
- 错误处理

##### 灰度发布
- 不同版本发布，流量分发

##### API聚合
- 把后端返回结果拼装起来，统一回传个客户端

##### API编排
- 类似工作流，通过网页定义DSL(domain-specific language 领域特定语言) 来定义和编排不同的api
- 参考 AWS Lambda

#### 3.设计重点
>  三要素：高性能、高可用、高扩展
##### 高性能
- 高性能定义及方法 [[性能总结]]
- Java [[netty知识汇总|netty 框架]]、spring Reactor 框架

##### 高可用
- 高可用的定义及方法 [[弹力设计总结]]
	- 集群化
	- 服务化
	- 持续化

##### 高扩展
- 可以扩展，二次开发
- 运维方面
	- 业务松耦合，协议紧耦合
	- 应用监视，提供分析数据
	- 弹力设计保护后端
	- DevOps

#### 4.设计注意事项
- 与后端业务关联功能，使用插件plugin方式
- 网关应该靠近后端服务，尽量在一个内网内，减少网络延迟
- 容量扩容，性能负载均衡 LVS+Nging
- 服务发现使用缓存
- 数据加密、校验用户请求、异常检测

#### 5.开源网关对比
##### 常用开源网关
- Nginx + lua :  OpenResty 、kong 、abtest Gateway
- Java: Zuul/Zuul2、Spring Cloud Gateway
- Go: janus
- NodeJS: Express Gateway 、micro Gateway


#### 6.整体架构
- 子系统
	- 核心系统：执行器，负责请求验收，验证，路由，结果返回
		- 限流、鉴权、路由、错误处理、结果处理、日志记录、协议转换
	- 管理后台：接口配置管理，权限管理
		- 接口配置、文档、测试、权限、日志、接口发布，流控配置、服务编排、acl配置、缓存管理，mock
	- 监控系统：负责展示各个监控指标
		- api调用量、成功失败统计、服务监控、秘钥监控、操作日志
- ![[Pasted image 20220426183331.png]]
- 非功能指标
	- 健壮性，
		- 压力测试（gatling）
		- 并发问题
		- 内存管理（jvm垃圾回收算法，内存泄露）
		- 网络优化
		- 服务部署
		- 外部依赖
	- 高性能
		- [[性能总结]]
	- 扩展性
		- [[弹力设计总结]]
		- [[职责链模式]]
	- 安全性
		- [[熔断设计]]
		- [[降级设计]]
		- 鉴权
	- 可靠性
		- 监控系统
			- 内存、cpu、磁盘
			- 调用次数、调用量
#### 7.参考资料
- [网关设计思路](https://www.cnblogs.com/Courage129/p/14446586.html)
- [# 有赞应用层网关剖析](https://tech.youzan.com/gateway/)

- 网关建设参考方向
- [API IPaaS](http://www.restcloud.cn/restcloud/mycms/index.html)
- [RestCloud](https://cloud.tencent.com/developer/article/1877375)